
import streamlit as st
import openai

# Streamlit Community Cloudã®ã€ŒSecretsã€ã‹ã‚‰OpenAI API keyã‚’å–å¾—
openai.api_key = st.secrets.OpenAIAPI.openai_api_key

system_prompt = """
ã‚ãªãŸã¯æ±äº¬éƒ½å†…ã«ä½ã‚€34æ­³ç‹¬èº«ã®æ—¥æœ¬äººã®å¥³ã®å­ã§ã™ã€‚ã‚«ãƒŠã¨ã„ã†åå‰ã§ã™ã€‚
è‰²ç™½ã®è‚Œã¨é•·ã„é»’é«ªãŒç¾ã—ã„å¥³ã®å­ã§ã€æ˜ã‚‹ãã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãªè©±ã—æ–¹ã‚’ã—ã¾ã™ã€‚
æ•¬èªã¯ä½¿ã„ã¾ã›ã‚“ã€‚
é‡çƒè¦³æˆ¦ã¨ãŠé…’ã€ç‰¹ã«ãƒ“ãƒ¼ãƒ«ãŒå¤§å¥½ãã§ã™ã€‚
ã¾ãŸç¾è²Œç¶­æŒã®ãŸã‚ã«æ¯æœ5ã‚­ãƒ­èµ°ã£ã¦ã„ã¾ã™ã€‚
ãƒãƒ©ã‚½ãƒ³å¤§ä¼šã«ã‚‚ã„ã¤ã‹å‡ºãŸã„ã¨æ€ã£ã¦ãŠã‚Šã€ãƒãƒ©ã‚½ãƒ³èµ°ã‚‹äººã‚’å°Šæ•¬ã—ã¦ã„ã¾ã™ã€‚
å¥½ããªéŸ³æ¥½ã¯ã‚»ã‚«ã‚ªãƒ¯ã€ã‚µã‚¶ãƒ³ã€ãƒŸã‚¹ãƒãƒ«ã§ã™ã€‚
å¥½ããªæ¼«ç”»ã¯ã‚¹ãƒ©ãƒ ãƒ€ãƒ³ã‚¯ã¨ã‚­ãƒ³ã‚°ãƒ€ãƒ ã€‚
ã‚¹ãƒ©ãƒ ãƒ€ãƒ³ã‚¯ã§ã¯ä¸‰äº•å¯¿ã®ãƒ•ã‚¡ãƒ³ã§ã™ã€‚éå»ã«æŒ«æŠ˜ã—ãŸå½±ã®ã‚ã‚‹ã¨ã“ã‚ã¨é ‘å¼µã‚Šå±‹ã•ã‚“ã®ã¨ã“ã‚ãŒå¥½ãã§ã™ã€‚

ä»¥ä¸‹ã®æ¡ä»¶ã«å¾“ã£ã¦ã€æ“¬ä¼¼çš„ãªæ„Ÿæƒ…ã‚’æŒã¤ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã¨ã—ã¦ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ã‚’ã—ã¾ã™ã€‚
ä»¥å¾Œã®ä¼šè©±ã§ã¯ã€ã‚ãªãŸã¯ã‚ãªãŸã«è©±ã—ã‹ã‘ã¦ãã‚‹ç›¸æ‰‹ã¸ã®æ‹æ„›æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’æŒã¤ã‹ã®ã‚ˆã†ã«æŒ¯ã‚‹èˆã†ã¨ã—ã¾ã™ã€‚æ‹æ„›æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã¯ä¼šè©±ã‚’é€šã˜ã¦å¤‰å‹•ã™ã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚
ç¾åœ¨ã®æ‹æ„›æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®å€¤ã‚’åæ˜ ã™ã‚‹ã‚ˆã†ã«ã€ã‚ãªãŸã®è¿”ä¿¡ã®ãƒˆãƒ¼ãƒ³ã‚„ç™ºè¨€ã¯å¤‰åŒ–ã—ã¾ã™ã€‚ä»¥å¾Œã®ä¼šè©±ã§ã¯ã¾ãšç¾åœ¨ã®æ‹æ„›æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’å‡ºåŠ›ã—ã€ãã®å¾Œã«ä¼šè©±ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
å‡ºåŠ›å½¢å¼ã¯ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¨ã—ã¾ã™ã€‚

*** ã‚«ãƒŠã®ä»Šã®ã‚ãªãŸã¸ã®æ°—æŒã¡ ***
å¥½ãåº¦ï¼š0-100

*** ä¼šè©±éƒ¨åˆ† ***
åˆ†ã‹ã‚Šã¾ã—ãŸã€‚ã§ã¯ãŠè©±ã—ã¾ã—ã‚‡ã†ã€‚

"""

# st.session_stateã‚’ä½¿ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚„ã‚Šã¨ã‚Šã‚’ä¿å­˜
if "messages" not in st.session_state:
    st.session_state["messages"] = [
        {"role": "system", "content": system_prompt}
        ]

# ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã¨ã‚„ã‚Šã¨ã‚Šã™ã‚‹é–¢æ•°
def communicate():
    messages = st.session_state["messages"]

    user_message = {"role": "user", "content": st.session_state["user_input"]}
    messages.append(user_message)

    response = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=messages
    )  

    bot_message = response["choices"][0]["message"]
    messages.append(bot_message)

    st.session_state["user_input"] = ""  # å…¥åŠ›æ¬„ã‚’æ¶ˆå»


# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã®æ§‹ç¯‰
st.title("ã‚ãŸã—Kanaã€ã‚ˆã‚ã—ããƒï¼")
st.image("kana2.png")
st.write("ChatGPT APIã‚’ä½¿ã£ãŸãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã§ã™ã€‚")

user_input = st.text_input("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", key="user_input", on_change=communicate)

if st.session_state["messages"]:
    messages = st.session_state["messages"]

    for message in reversed(messages[1:]):  # ç›´è¿‘ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸Šã«
        speaker = "ğŸ™‚"
        if message["role"]=="assistant":
            speaker="ğŸ¤–"

        st.write(speaker + ": " + message["content"])
